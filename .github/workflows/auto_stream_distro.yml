name: Build AutoSD Base Image

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-autosd-image:
    name: Build Auto Stream Distribution Base Image
    runs-on: ubuntu-22.04-arm # ubuntu-latest  Use GitHub-hosted runner
    # container:
      # image: ubuntu-22.04-arm  # Use an arm64 container

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip osbuild osbuild-composer \
                           qemu-utils jq

    - name: Clone CentOS AutoSD Repository
      run: |
        git clone https://git.centos.org/rpms/automotive-image-builder.git
        cd automotive-image-builder
        git checkout main  # Or a specific branch/tag if needed

    - name: Configure OSBuild for AutoSD
      run: |
        cd automotive-image-builder
        mkdir -p osbuild-configs
        cat <<EOF > osbuild-configs/autosd-base-image.json
        {
          "version": "1",
          "pipelines": [
            {
              "name": "build",
              "build": "name:org.osbuild.fedora34",
              "stages": [
                {
                  "type": "org.osbuild.rpm",
                  "inputs": [
                    {
                      "type": "org.osbuild.files",
                      "origin": "org.osbuild.source",
                      "references": []
                    }
                  ]
                }
              ]
            },
            {
              "name": "assembler",
              "stages": [
                {
                  "type": "org.osbuild.qemu",
                  "options": {
                    "format": "qcow2"
                  }
                }
              ]
            }
          ]
        }
        EOF

    - name: Build Image with OSBuild
      run: |
        cd automotive-image-builder/osbuild-configs
        sudo osbuild autosd-base-image.json --output-directory ../output

    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: autosd-base-image
        path: automotive-image-builder/output/*.qcow2
